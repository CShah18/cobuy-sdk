"use strict";const p={config:{apiBaseUrl:"",allowImpression:!0},init(e={}){this.config={...this.config,...e},this.loadAds()},async loadAds(){const e=document.querySelectorAll(".cobuy-ad");e.length&&e.forEach(async t=>{const s=t.dataset.campaign||"unknown",o=t.dataset.brand||"",a=t.dataset.width||"300",r=t.dataset.height||"250",n=t.dataset.apiBase||this.config.apiBaseUrl,l=t.dataset.clickTracker,m=t.dataset.image;if(!n){console.error("[CoBuySDK] Missing apiBase in ad tag");return}try{let i=m;if(!i){const d=await this.fetchCreative(n,s);if(!d||!d.url){console.error("[CoBuySDK] No creative returned from API");return}i=d.url}this.renderCreative(t,i,a,r,l),this.config.allowImpression&&this.emitImpression({apiBase:n,campaignId:s,brand:o,width:a,height:r})}catch(i){console.error("[CoBuySDK] Error loading creative:",i)}})},async fetchCreative(e,t){const s=`${e}/api/v1/creative?cid=${encodeURIComponent(t)}&cb=${Date.now()}`,o=await fetch(s);if(!o.ok)throw new Error(`Creative fetch failed: ${o.status}`);return o.json()},renderCreative(e,t,s,o,a){e.innerHTML="",e.style.position="relative",e.style.display="inline-block",e.style.width=`${s}px`,e.style.height=`${o}px`;const r=/\.(jpg|jpeg|png|gif|webp|avif)$/i.test(t);let n;r?(n=document.createElement("img"),n.src=t,n.width=s,n.height=o,n.style.border="none",n.style.display="block"):(n=document.createElement("iframe"),n.src=t,n.width=s,n.height=o,n.frameBorder="0",n.scrolling="no",n.style.border="none"),e.appendChild(n);const l=e.dataset.campaign,m=this.config.apiBaseUrl||e.dataset.apiBase,i=a||"https://google.com",d=i.includes("%%CLICK_URL%%")?i:encodeURIComponent(i),g=`${m}/trk/click?src=cobuy&cid=${encodeURIComponent(l)}&crid=${encodeURIComponent(s+"x"+o)}&pub=web&plc=banner&dest=${d}&clid=${Date.now()}`,c=document.createElement("a");c.href=g,c.target="_blank",c.rel="noopener",Object.assign(c.style,{position:"absolute",top:0,left:0,width:"100%",height:"100%",textDecoration:"none",cursor:"pointer"}),c.addEventListener("click",()=>{this.emitEvent("click",{campaign_id:l}),console.log("[CoBuySDK] Click fired â†’",g)}),e.appendChild(c)},emitImpression({apiBase:e,campaignId:t,brand:s,width:o,height:a}){const r=`${e}/api/v1/tracking/imp?src=cobuy&cid=${encodeURIComponent(t)}&crid=${encodeURIComponent(o+"x"+a)}&pub=web&plc=banner&cb=${Date.now()}`,n=new Image(1,1);n.src=r,n.style="position:absolute;left:-9999px;top:-9999px;",document.body.appendChild(n),console.log("[CoBuySDK] Impression fired:",r)},emitEvent(e,t={}){const s=`${this.config.apiBaseUrl}/events`,o={event_type:e,timestamp:new Date().toISOString(),...t};fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}).catch(a=>console.error("[CoBuySDK] Event error:",a.message))},createShareLinks(e,t={}){const s=this.addUTMParams(e,t),o=encodeURIComponent(s);return{whatsapp:`https://wa.me/?text=${o}`,sms:`sms:?body=${o}`,copy:s}},addUTMParams(e,t={}){const s=new URLSearchParams(t).toString();if(!s)return e;const o=e.includes("?")?"&":"?";return`${e}${o}${s}`}};typeof window<"u"&&(document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>p.init()):p.init(),window.CoBuySDK=p);module.exports=p;
